<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Noise Logic Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #222;
            --panel: #333;
            --text: #ddd;
            --accent: #5577ff;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        h2 { margin-top: 0; }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1000px;
            width: 100%;
        }
        .controls {
            flex: 1;
            min-width: 300px;
            background: var(--panel);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .graph-container {
            flex: 2;
            min-width: 300px;
            background: var(--panel);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            height: 400px;
            position: relative;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        .stats {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #555;
            font-size: 0.9em;
            color: #aaa;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .val-highlight {
            color: #fff;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- CONTROLS -->
        <div class="controls">
            <h2>Parameters</h2>
            
            <div class="control-group">
                <label>Steps <span id="val_steps" class="val-highlight">12</span></label>
                <input type="range" id="steps" min="4" max="50" value="12" step="1">
            </div>

            <div class="control-group">
                <label>Num Segments <span id="val_segments" class="val-highlight">3</span></label>
                <input type="range" id="num_segments" min="1" max="10" value="3" step="1">
            </div>

            <div class="control-group">
                <label>Chaos Factor <span id="val_chaos" class="val-highlight">0.5</span></label>
                <input type="range" id="chaos_factor" min="0.0" max="1.0" value="0.5" step="0.01">
            </div>

            <div class="control-group">
                <label>Strength Scale <span id="val_scale" class="val-highlight">1.0</span></label>
                <input type="range" id="strength_scale" min="0.0" max="2.0" value="1.0" step="0.1">
            </div>

            <div class="stats">
                <div class="stat-row"><span>Calculated Duration:</span> <span id="calc_duration" class="val-highlight">-</span></div>
                <div class="stat-row"><span>Peak Strength:</span> <span id="calc_peak" class="val-highlight">-</span></div>
                <div class="stat-row"><span>Curve Type:</span> <span id="calc_type" class="val-highlight">-</span></div>
            </div>
        </div>

        <!-- GRAPH -->
        <div class="graph-container">
            <canvas id="noiseChart"></canvas>
        </div>
    </div>

<script>
    // ==========================================
    // 1. THE LOGIC (Direct Port from Python)
    // ==========================================
    function calculateCurve(steps, num_segments, chaos_factor, strength_scale) {
        // --- 1. Basic Setup ---
        const step_len = 1.0 / Math.max(1, steps);

        // --- 2. Determine Max Duration ---
        // min_duration = step_len * 1.5 
        // max_duration = 0.60
        const min_duration = step_len * 1.5;
        const max_duration = 0.60;
        
        // target_duration = min_duration + (max_duration - min_duration) * chaos_factor
        let target_duration = min_duration + (max_duration - min_duration) * chaos_factor;
        
        // Clamp to 1.0
        target_duration = Math.min(target_duration, 1.0);

        // --- 3. Determine Peak Strength ---
        // min_peak = 2.0, max_peak = 20.0
        const min_peak = 2.0;
        const max_peak = 20.0;
        const peak_strength = min_peak + (max_peak - min_peak) * chaos_factor;

        // --- 4. Generate Segments ---
        const chunk_size = target_duration / num_segments;
        const graphData = [];

        let current_time = 0.0;

        for (let i = 0; i < num_segments; i++) {
            const start = current_time;
            const end = current_time + chunk_size;

            // Calculate Decay
            // progress = i / max(1, num_segments - 1)
            const progress = (num_segments > 1) ? (i / (num_segments - 1)) : 0.0;
            
            // Linear decay: segment_strength = peak_strength * (1.0 - (progress * 0.9))
            const segment_strength = peak_strength * (1.0 - (progress * 0.9));
            
            // Apply Scale
            const final_strength = segment_strength * strength_scale;

            // --- Store for Graph ---
            // To make "Square" steps in line graph, we add point at start and end
            graphData.push({ x: start, y: final_strength });
            graphData.push({ x: end, y: final_strength });

            current_time = end;
        }

        // Add tail (clean)
        graphData.push({ x: current_time, y: 0 });
        graphData.push({ x: 1.0, y: 0 });

        return {
            data: graphData,
            meta: {
                duration: target_duration,
                peak: peak_strength * strength_scale
            }
        };
    }

    // ==========================================
    // 2. CHART SETUP
    // ==========================================
    const ctx = document.getElementById('noiseChart').getContext('2d');
    
    // Custom plugin to draw vertical lines for "Steps"
    const verticalGridPlugin = {
        id: 'verticalGrid',
        beforeDraw: (chart) => {
            const steps = parseInt(document.getElementById('steps').value);
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;

            ctx.save();
            ctx.strokeStyle = '#444'; // Grid color
            ctx.lineWidth = 1;
            ctx.setLineDash([2, 4]); // Dashed line

            const stepSize = 1.0 / steps;

            for (let i = 1; i < steps; i++) {
                const xVal = i * stepSize;
                const xPos = xAxis.getPixelForValue(xVal);
                
                // Draw line
                ctx.beginPath();
                ctx.moveTo(xPos, yAxis.top);
                ctx.lineTo(xPos, yAxis.bottom);
                ctx.stroke();

                // Draw Step number text
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(i, xPos, yAxis.bottom + 12);
            }
            ctx.restore();
        }
    };

    const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Noise Strength',
                data: [],
                showLine: true,
                borderColor: '#5577ff',
                backgroundColor: 'rgba(85, 119, 255, 0.2)',
                borderWidth: 2,
                pointRadius: 0, // Hide points for clean look
                fill: true,
                stepped: false, // We manually create steps with start/end points
                tension: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 0 }, // Instant updates
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: 1,
                    title: { display: true, text: 'Generation Progress (0.0 to 1.0)' },
                    grid: { display: false } // We draw custom grid
                },
                y: {
                    min: 0,
                    suggestedMax: 20,
                    title: { display: true, text: 'Strength' },
                    grid: { color: '#333' }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'nearest',
                    intersect: false,
                    callbacks: {
                        label: (context) => `Strength: ${context.parsed.y.toFixed(2)}`
                    }
                }
            }
        },
        plugins: [verticalGridPlugin]
    });

    // ==========================================
    // 3. UI INTERACTION
    // ==========================================
    const inputs = {
        steps: document.getElementById('steps'),
        num_segments: document.getElementById('num_segments'),
        chaos_factor: document.getElementById('chaos_factor'),
        strength_scale: document.getElementById('strength_scale')
    };

    const displays = {
        steps: document.getElementById('val_steps'),
        num_segments: document.getElementById('val_segments'),
        chaos_factor: document.getElementById('val_chaos'),
        strength_scale: document.getElementById('val_scale'),
        
        calc_duration: document.getElementById('calc_duration'),
        calc_peak: document.getElementById('calc_peak'),
        calc_type: document.getElementById('calc_type')
    };

    function update() {
        // Read values
        const steps = parseInt(inputs.steps.value);
        const segments = parseInt(inputs.num_segments.value);
        const chaos = parseFloat(inputs.chaos_factor.value);
        const scale = parseFloat(inputs.strength_scale.value);

        // Update Text Labels
        displays.steps.innerText = steps;
        displays.num_segments.innerText = segments;
        displays.chaos_factor.innerText = chaos.toFixed(2);
        displays.strength_scale.innerText = scale.toFixed(1);

        // Run Logic
        const result = calculateCurve(steps, segments, chaos, scale);

        // Update Stats
        const durPercent = (result.meta.duration * 100).toFixed(0);
        const stepsCovered = (result.meta.duration * steps).toFixed(1);
        
        displays.calc_duration.innerText = `${durPercent}% (${stepsCovered} steps)`;
        displays.calc_peak.innerText = result.meta.peak.toFixed(2);
        
        let typeText = "Balanced";
        if (chaos < 0.3) typeText = "Subtle Polish";
        if (chaos > 0.7) typeText = "High Chaos";
        displays.calc_type.innerText = typeText;

        // Update Chart
        chart.data.datasets[0].data = result.data;
        chart.update();
    }

    // Attach listeners
    Object.values(inputs).forEach(el => el.addEventListener('input', update));

    // Init
    update();

</script>
</body>
</html>